<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>wdom.testing &mdash; WDOM 0.1.8 documentation</title>
    
    <link rel="stylesheet" href="../../_static/slex.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="WDOM 0.1.8 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
  <!-- font -->
  <link href='https://fonts.googleapis.com/css?family=Raleway:500' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <!-- Style -->
  <link rel="stylesheet" href="//cdn.concisecss.com/v3.4.0/concise.min.css">
  
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head>
  <body role="document">
  <div class="document"> 
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">

  <h1 class="logo"><a href="../../index.html">WDOM</a></h1>



  <p class="blurb">Browser-based GUI Library for Python</p>



  
    
      <a class="github-mark" href="https://github.com/miyakogi/wdom/">
        <img class="github-mark" src="../../_static/GitHub-Mark-64px.png">
      </a>
    
  





<h3>Contents</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changes</a></li>
</ul>


<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div class="searchbox" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div class="search-container">
        <input class="form-control control search-input" type="text" name="q" />
        <button class="btn button search-btn" type="submit" value="Go" />Go</button>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </div>
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
      </div>
    </div> 
      <div class="documentwrapper">
        <div class="body" role="main">
          
  <h1>Source code for wdom.testing</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;Utility test-functions/classes to test WDOM on browser.</span>

<span class="sd">This module depend on selenium webdriver, so please install selenium before</span>
<span class="sd">use this module::</span>

<span class="sd">    pip install selenium</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">multiprocessing.connection</span> <span class="k">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">from</span> <span class="nn">selenium</span> <span class="k">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="k">import</span> <span class="n">NoSuchElementException</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.utils</span> <span class="k">import</span> <span class="n">free_port</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.remote.webdriver</span> <span class="k">import</span> <span class="n">WebDriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.remote.webelement</span> <span class="k">import</span> <span class="n">WebElement</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support.select</span> <span class="k">import</span> <span class="n">Select</span>

<span class="kn">from</span> <span class="nn">tornado.httpclient</span> <span class="k">import</span> <span class="n">AsyncHTTPClient</span><span class="p">,</span> <span class="n">HTTPResponse</span>
<span class="kn">from</span> <span class="nn">tornado.platform.asyncio</span> <span class="k">import</span> <span class="n">AsyncIOMainLoop</span><span class="p">,</span> <span class="n">to_asyncio_future</span>
<span class="kn">from</span> <span class="nn">tornado.websocket</span> <span class="k">import</span> <span class="n">websocket_connect</span><span class="p">,</span> <span class="n">WebSocketClientConnection</span>

<span class="kn">from</span> <span class="nn">wdom</span> <span class="k">import</span> <span class="n">options</span><span class="p">,</span> <span class="n">server</span>
<span class="kn">from</span> <span class="nn">wdom.element</span> <span class="k">import</span> <span class="n">Element</span>
<span class="kn">from</span> <span class="nn">wdom.util</span> <span class="k">import</span> <span class="n">install_asyncio</span>
<span class="kn">from</span> <span class="nn">wdom.window</span> <span class="k">import</span> <span class="n">customElements</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">asyncio</span> <span class="k">import</span> <span class="n">AbstractEventLoop</span>  <span class="c1"># noqa</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span>  <span class="c1"># noqa</span>

<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span>
<span class="n">local_webdriver</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">remote_webdriver</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">browser_implict_wait</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wdom&#39;</span><span class="p">)</span>
<span class="n">server_config</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">server_config</span>


<span class="k">def</span> <span class="nf">_get_chromedriver_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get path to chromedriver executable.</span>

<span class="sd">    Usually it is on the project root.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;TRAVIS&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">chromedriver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TRAVIS_BUILD_DIR&#39;</span><span class="p">],</span> <span class="s1">&#39;chromedriver&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chromedriver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span>
            <span class="s1">&#39;chromedriver&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">chromedriver_path</span>


<span class="c1"># see https://www.spirulasystems.com/blog/2016/08/11/https-everywhere-unit-testing-for-chromium/  # noqa: E501</span>
<span class="k">def</span> <span class="nf">get_chrome_options</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get default chrome options.&quot;&quot;&quot;</span>
    <span class="n">chrome_options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;TRAVIS&#39;</span><span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">chrome_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-sandbox&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chrome_options</span>


<div class="viewcode-block" id="reset"><a class="viewcode-back" href="../../test.html#wdom.testing.reset">[docs]</a><span class="k">def</span> <span class="nf">reset</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Reset all wdom objects.</span>

<span class="sd">    This function clear all connections, elements, and resistered custom</span>
<span class="sd">    elements. This function also makes new document/application and set them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wdom.document</span> <span class="k">import</span> <span class="n">get_new_document</span><span class="p">,</span> <span class="n">set_document</span>
    <span class="n">set_document</span><span class="p">(</span><span class="n">get_new_document</span><span class="p">())</span>
    <span class="kn">from</span> <span class="nn">wdom.server</span> <span class="k">import</span> <span class="n">_tornado</span>
    <span class="n">_tornado</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">_tornado</span><span class="o">.</span><span class="n">set_application</span><span class="p">(</span><span class="n">_tornado</span><span class="o">.</span><span class="n">Application</span><span class="p">())</span>
    <span class="n">Element</span><span class="o">.</span><span class="n">_elements_with_id</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">Element</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">customElements</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../test.html#wdom.testing.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for testing wdom modules.</span>

<span class="sd">    This class is a sub class of the ``unittest.TestCase``. After all test</span>
<span class="sd">    methods, reset wdom&#39;s global objects like document, application, and</span>
<span class="sd">    elements. If you use ``tearDown`` method, do not forget to call</span>
<span class="sd">    ``super().tearDown()``.</span>

<span class="sd">    If you want to reuse document/application object in your test class, please</span>
<span class="sd">    set them in each setup phase as follow::</span>

<span class="sd">        @classmethod</span>
<span class="sd">        def setUpClass(cls):</span>
<span class="sd">            cls.your_doc = get_document()</span>
<span class="sd">            cls.your_app = get_app()</span>

<span class="sd">        def setUp(self):</span>
<span class="sd">            from wdom.document import set_document</span>
<span class="sd">            from wdom.server import set_application</span>
<span class="sd">            set_document(self.your_doc)</span>
<span class="sd">            set_application(self.your_app)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: D102</span>
        <span class="n">reset</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

<div class="viewcode-block" id="TestCase.assertIsTrue"><a class="viewcode-back" href="../../test.html#wdom.testing.TestCase.assertIsTrue">[docs]</a>    <span class="k">def</span> <span class="nf">assertIsTrue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bl</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check arg is exactly True, not truthy.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.assertIsFalse"><a class="viewcode-back" href="../../test.html#wdom.testing.TestCase.assertIsFalse">[docs]</a>    <span class="k">def</span> <span class="nf">assertIsFalse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bl</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check arg is exactly False, not falsy.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HTTPTestCase"><a class="viewcode-back" href="../../test.html#wdom.testing.HTTPTestCase">[docs]</a><span class="k">class</span> <span class="nc">HTTPTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For http/ws connection test.&quot;&quot;&quot;</span>

    <span class="n">wait_time</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TRAVIS&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.01</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">_server_started</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_ws_connections</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Connection]</span>

<div class="viewcode-block" id="HTTPTestCase.start"><a class="viewcode-back" href="../../test.html#wdom.testing.HTTPTestCase.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start web server.</span>

<span class="sd">        Please call this method after prepraring document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">root_logger</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">server_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span> <span class="o">=</span> <span class="s1">&#39;ws://localhost:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_started</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HTTPTestCase.tearDown"><a class="viewcode-back" href="../../test.html#wdom.testing.HTTPTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Terminate server and close all ws client connections.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_started</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">root_logger</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
                <span class="n">server</span><span class="o">.</span><span class="n">stop_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connections</span><span class="p">:</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connections</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span></div>

<div class="viewcode-block" id="HTTPTestCase.fetch"><a class="viewcode-back" href="../../test.html#wdom.testing.HTTPTestCase.fetch">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTTPResponse</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch url and return ``tornado.httpclient.HTTPResponse`` object.</span>

<span class="sd">        Response body is decoded by ``encoding`` and set ``text`` property of</span>
<span class="sd">        the response. If failed to decode, ``text`` property will be ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">to_asyncio_future</span><span class="p">(</span>
            <span class="n">AsyncHTTPClient</span><span class="p">()</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="HTTPTestCase.ws_connect"><a class="viewcode-back" href="../../test.html#wdom.testing.HTTPTestCase.ws_connect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">ws_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSocketClientConnection</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make WebSocket connection to the url.</span>

<span class="sd">        Retries up to _max (default: 20) times. Client connections made by this</span>
<span class="sd">        method are closed after each test method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="k">await</span> <span class="n">to_asyncio_future</span><span class="p">(</span><span class="n">websocket_connect</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ConnectionRefusedError</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ws</span>
        <span class="k">raise</span> <span class="ne">ConnectionRefusedError</span><span class="p">(</span>
            <span class="s1">&#39;WebSocket connection refused: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span></div>

<div class="viewcode-block" id="HTTPTestCase.wait"><a class="viewcode-back" href="../../test.html#wdom.testing.HTTPTestCase.wait">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Coroutine to wait for ``timeout``.</span>

<span class="sd">        ``timeout`` is second to wait, and its default value is</span>
<span class="sd">        ``self.wait_time``. If ``times`` are specified, wait for</span>
<span class="sd">        ``timeout * times``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">start_webdriver</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Start WebDriver and set implicit_wait if it is not started.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">local_webdriver</span>
    <span class="k">if</span> <span class="n">local_webdriver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">local_webdriver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">(</span>
            <span class="n">executable_path</span><span class="o">=</span><span class="n">_get_chromedriver_path</span><span class="p">(),</span>
            <span class="n">chrome_options</span><span class="o">=</span><span class="n">get_chrome_options</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">browser_implict_wait</span><span class="p">:</span>
            <span class="n">local_webdriver</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="n">browser_implict_wait</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">close_webdriver</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Close WebDriver.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">local_webdriver</span>
    <span class="k">if</span> <span class="n">local_webdriver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">local_webdriver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">local_webdriver</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_webdriver</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">WebDriver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return WebDriver of current process.</span>

<span class="sd">    If it is not started yet, start and return it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local_webdriver&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_webdriver</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">local_webdriver</span>


<span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Connection</span>
<span class="n">wd_conn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Connection</span>
<span class="n">browser_manager</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">remote_webdriver</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_clear</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">conn</span><span class="p">,</span> <span class="n">wd_conn</span><span class="p">,</span> <span class="n">browser_manager</span><span class="p">,</span> <span class="n">remote_webdriver</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wd_conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">browser_manager</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">remote_webdriver</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">start_remote_browser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Start remote browser process.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">browser_manager</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">wd_conn</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">wd_conn</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_browser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">wd_conn</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">BrowserController</span><span class="p">(</span><span class="n">wd_conn</span><span class="p">)</span>
        <span class="n">bc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">browser_manager</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_browser</span><span class="p">)</span>
    <span class="n">browser_manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">close_remote_browser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Terminate remote browser process.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">conn</span><span class="p">,</span> <span class="n">browser_manager</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;quit&#39;</span><span class="p">})</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Remote Browser closed&#39;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">browser_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">browser_manager</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">_clear</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_remote_browser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">WebDriver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Start new WebDriver for remote process.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">remote_webdriver</span>
    <span class="k">if</span> <span class="n">remote_webdriver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">remote_webdriver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">(</span>
            <span class="n">executable_path</span><span class="o">=</span><span class="n">_get_chromedriver_path</span><span class="p">(),</span>
            <span class="n">chrome_options</span><span class="o">=</span><span class="n">get_chrome_options</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">browser_implict_wait</span><span class="p">:</span>
            <span class="n">remote_webdriver</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="n">browser_implict_wait</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">remote_webdriver</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">remote_webdriver</span>


<span class="k">class</span> <span class="nc">BrowserController</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class to run and wrap webdriver in different proceess.&quot;&quot;&quot;</span>

    <span class="n">_select_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Select</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">Connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set up connection and start webdriver.</span>

<span class="sd">        ``conn`` is a one end of ``Pipe()``, which is used the inter-process</span>
<span class="sd">        communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span> <span class="o">=</span> <span class="n">get_remote_browser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_element_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find element with ``id`` and set it to element property.</span>

<span class="sd">        When successfully find the element, send ``True``. If failed to find</span>
<span class="sd">        the element, send message ``Error NoSuchElement: {{ id }}``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="s1">&#39;[rimo_id=&quot;</span><span class="si">{}</span><span class="s1">&quot;]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">NoSuchElementException</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Error NoSuchElement: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Terminate WebDriver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;closed&#39;</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close WebDriver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;closed&#39;</span>

    <span class="k">def</span> <span class="nf">_execute_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not callable, just send it back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: C901</span>
        <span class="sd">&quot;&quot;&quot;Wait message from the other end of the connection.</span>

<span class="sd">        When gat message, execute the method specified by the message. The</span>
<span class="sd">        message should be a python&#39;s dict, which must have ``target`` and</span>
<span class="sd">        ``method`` field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;process&#39;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;browser&#39;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;element&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Element must be set</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Error: No Element Set&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">method_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_methods</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">tag_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;select&#39;</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">Select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_method</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">wait_for</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wait the response from the remote process and return it.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">wait_coro</span><span class="p">())</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_coro</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wait response from the other process.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>


<span class="k">def</span> <span class="nf">_get_properties</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">props</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">)):</span>
            <span class="n">props</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">props</span>


<span class="k">class</span> <span class="nc">Controller</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for remote browser controller.&quot;&quot;&quot;</span>

    <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[str]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call methods related to this controller.&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">conn</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">wait_for</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Error NoSuchElement&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">NoSuchElementException</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">ProcessController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Controller of remote browser process.&quot;&quot;&quot;</span>

    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;process&#39;</span>


<span class="k">class</span> <span class="nc">RemoteBrowserController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Controller of remote web driver.&quot;&quot;&quot;</span>

    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">_get_properties</span><span class="p">(</span><span class="n">WebDriver</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RemoteElementController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Controller of remote web driver element.&quot;&quot;&quot;</span>

    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;element&#39;</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">_get_properties</span><span class="p">(</span><span class="n">WebElement</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The operation is not completed by timeout.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="RemoteBrowserTestCase"><a class="viewcode-back" href="../../test.html#wdom.testing.RemoteBrowserTestCase">[docs]</a><span class="k">class</span> <span class="nc">RemoteBrowserTestCase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class is **Experimental**.</span>

<span class="sd">    Utility class for testing apps with webdriver in another process. Mainly</span>
<span class="sd">    used for development and test of wdom library itself. This class does not</span>
<span class="sd">    support all methods provided by selenium.webdriver, but maybe enough.</span>

<span class="sd">    After seting up your document, call ``start`` method in setup sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: seconds to wait for by ``wait`` method.</span>
    <span class="n">wait_time</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="c1">#: secondes for deault timeout for ``wait_until`` method</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mf">1.0</span>

<div class="viewcode-block" id="RemoteBrowserTestCase.start"><a class="viewcode-back" href="../../test.html#wdom.testing.RemoteBrowserTestCase.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start remote browser process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prev_logging</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logging</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logging</span> <span class="o">=</span> <span class="s1">&#39;warn&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">ProcessController</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">RemoteBrowserController</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">RemoteElementController</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">server_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">is_connected</span><span class="p">())</span></div>

<div class="viewcode-block" id="RemoteBrowserTestCase.tearDown"><a class="viewcode-back" href="../../test.html#wdom.testing.RemoteBrowserTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run tear down process.</span>

<span class="sd">        Reset log-level, stop web server, and flush stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_logging</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop_server</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>  <span class="c1"># type: ignore</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get port of the server.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">server_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="RemoteBrowserTestCase.wait"><a class="viewcode-back" href="../../test.html#wdom.testing.RemoteBrowserTestCase.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Wait for ``timeout`` seconds.</span>

<span class="sd">        Default timeout is ``RemoteBrowserTestCase.wait_time``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">))</span></div>

<div class="viewcode-block" id="RemoteBrowserTestCase.wait_until"><a class="viewcode-back" href="../../test.html#wdom.testing.RemoteBrowserTestCase.wait_until">[docs]</a>    <span class="k">def</span> <span class="nf">wait_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">],</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Wait until ``func`` returns True or exceeds timeout.</span>

<span class="sd">        ``func`` is called with no argument. Unit of ``timeout`` is second, and</span>
<span class="sd">        its default value is RemoteBrowserTestCase.timeout class variable</span>
<span class="sd">        (default: 1.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> did not return True until timeout&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_set_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">set_element_by_id</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rimo_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="n">NoSuchElementException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="RemoteBrowserTestCase.set_element"><a class="viewcode-back" href="../../test.html#wdom.testing.RemoteBrowserTestCase.set_element">[docs]</a>    <span class="k">def</span> <span class="nf">set_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the ``node`` as a target node of the remote browser process.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_until</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_element</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span> <span class="n">NoSuchElementException</span><span class="p">(</span><span class="s1">&#39;element not found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="WebDriverTestCase"><a class="viewcode-back" href="../../test.html#wdom.testing.WebDriverTestCase">[docs]</a><span class="k">class</span> <span class="nc">WebDriverTestCase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for testing UI on browser.</span>

<span class="sd">    This class starts up an HTTP server on a new subprocess.</span>

<span class="sd">    Subclasses should call ``start`` method after seting up your document.</span>
<span class="sd">    After ``start`` method called, the web server is running on the other</span>
<span class="sd">    process so you cannot make change on the document. If you need to change</span>
<span class="sd">    document after server started, please use ``RemoteBrowserTestCase`` class</span>
<span class="sd">    instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: seconds to wait for by ``wait`` method.</span>
    <span class="n">wait_time</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="c1">#: secondes for deault timeout for ``wait_until`` method</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">_orig_loop</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: AbstractEventLoop</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: D102</span>
        <span class="c1"># Keep original loop</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_orig_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="c1"># When change default loop, tornado&#39;s ioloop needs to be reinstalled</span>
        <span class="n">AsyncIOMainLoop</span><span class="p">()</span><span class="o">.</span><span class="n">clear_current</span><span class="p">()</span>
        <span class="n">AsyncIOMainLoop</span><span class="p">()</span><span class="o">.</span><span class="n">clear_instance</span><span class="p">()</span>
        <span class="n">install_asyncio</span><span class="p">()</span>
        <span class="n">reset</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: D102</span>
        <span class="c1"># Set original loop and reinstall to tornado</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_orig_loop</span><span class="p">)</span>
        <span class="n">AsyncIOMainLoop</span><span class="p">()</span><span class="o">.</span><span class="n">clear_current</span><span class="p">()</span>
        <span class="n">AsyncIOMainLoop</span><span class="p">()</span><span class="o">.</span><span class="n">clear_instance</span><span class="p">()</span>
        <span class="n">install_asyncio</span><span class="p">()</span>
        <span class="n">reset</span><span class="p">()</span>

<div class="viewcode-block" id="WebDriverTestCase.start"><a class="viewcode-back" href="../../test.html#wdom.testing.WebDriverTestCase.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start server and web driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span> <span class="o">=</span> <span class="n">get_webdriver</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">start_server</span><span class="p">(</span><span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">asyncio</span>
            <span class="kn">from</span> <span class="nn">wdom</span> <span class="k">import</span> <span class="n">server</span>
            <span class="n">server</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">free_port</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">start_server</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebDriverTestCase.tearDown"><a class="viewcode-back" href="../../test.html#wdom.testing.WebDriverTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Terminate server subprocess.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="WebDriverTestCase.wait"><a class="viewcode-back" href="../../test.html#wdom.testing.WebDriverTestCase.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Wait for ``timeout`` or ``self.wait_time``.&quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">))</span></div>

<div class="viewcode-block" id="WebDriverTestCase.wait_until"><a class="viewcode-back" href="../../test.html#wdom.testing.WebDriverTestCase.wait_until">[docs]</a>    <span class="k">def</span> <span class="nf">wait_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">],</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Wait until ``func`` returns True or exceeds timeout.</span>

<span class="sd">        ``func`` is called with no argument. Unit of ``timeout`` is second, and</span>
<span class="sd">        its default value is RemoteBrowserTestCase.timeout class variable</span>
<span class="sd">        (default: 1.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> did not return True until timeout&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span></div>

<div class="viewcode-block" id="WebDriverTestCase.send_keys"><a class="viewcode-back" href="../../test.html#wdom.testing.WebDriverTestCase.send_keys">[docs]</a>    <span class="k">def</span> <span class="nf">send_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send ``keys`` to ``element`` one-by-one.</span>

<span class="sd">        Safer than using ``element.send_keys`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div></div>
</pre></div>

        </div>
      </div>
  </div>
  <div class="footer">
    &copy;2016, Hiroyuki Takagi.
    
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      
    
  </div>

  
    <a href="https://github.com/miyakogi/wdom" class="github">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
  

  

  </body>
</html>